#set text(
  font: "Times New Roman",
  size: 14pt
)
#set quote(block: true)

#align(center)[–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ –Ω–∞—É–∫–∏ –∏ –≤—ã—Å—à–µ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏]
#align(center)[–§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ]
#align(center)[–í—ã—Å—à–µ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è]
#align(center)[_–§–∞–∫—É–ª—å—Ç–µ—Ç –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–π –ò–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π –¢–µ—Ö–Ω–∏–∫–∏_]

#v(8em)

#align(center)[*–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 3 –ø–æ –†–°–•–î*]
#align(center)[–í–∞—Ä–∏–∞–Ω—Ç 51486]

#v(8em)

#align(right)[–ì—Ä—É–ø–ø–∞: P3316]
#align(right)[–í—ã–ø–æ–ª–Ω–∏–ª–∏:]
#align(right)[–°–∏—Ä–∞–∑–µ—Ç–¥–∏–Ω–æ–≤, –®–ø–∏–Ω–µ–≤–∞]
#align(right)[–ü—Ä–æ–≤–µ—Ä–∏–ª:]
#align(right)[–ù–∏–∫–æ–ª–∞–µ–≤ –í.–í.]

#v(8em)

#align(center)[–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥]
#align(center)[2025]

#pagebreak()

= –ó–∞–¥–∞–Ω–∏–µ

== –¶–µ–ª—å —Ä–∞–±–æ—Ç—ã

–¶–µ–ª—å —Ä–∞–±–æ—Ç—ã - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤ —Ö–æ–¥–µ
–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã ‚Ññ2, –∞ —Ç–∞–∫–∂–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –∏ –æ—Ç–ª–∞–¥–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–ª—É—á–∞–µ —Å–±–æ–µ–≤.

–£–∑–µ–ª –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ. –ù–æ–≤—ã–π —É–∑–µ–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ.
–£—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–æ–≤–æ–º—É —É–∑–ª—É –≤—ã–¥–∞—ë—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å. –í —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—É—é –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ –¥–∞–Ω–Ω–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

== –≠—Ç–∞–ø 1. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–æ–ª–Ω—ã–µ –∫–æ–ø–∏–∏ + –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ.
–í–∫–ª—é—á–∏—Ç—å –¥–ª—è –°–£–ë–î —Ä–µ–∂–∏–º –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è WAL; –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (```scp```) –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —É–∑–µ–ª; –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω–æ–µ
—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (pg_basebackup) –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (cron) —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é. –°–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–µ –∫–æ–ø–∏–∏ –¥–æ–ª–∂–Ω—ã —Å—Ä–∞–∑—É
–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è (scp) –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ö–æ—Å—Ç. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–ø–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ - 1 –Ω–µ–¥–µ–ª—è, –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π - 4 –Ω–µ–¥–µ–ª–∏.
–ü–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã –∏ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ WAL –¥–æ–ª–∂–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–Ω–∏—á—Ç–æ–∂–∞—Ç—å—Å—è.

- –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å, –∫–∞–∫–æ–≤ –±—É–¥–µ—Ç –æ–±—ä–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —Å–ø—É—Å—Ç—è –º–µ—Å—è—Ü —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã, –∏—Å—Ö–æ–¥—è –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —É—Å–ª–æ–≤–∏–π:
–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î –∑–∞ —Å—É—Ç–∫–∏: 350–ú–ë.
–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å—É—Ç–∫–∏: 800–ú–ë.
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

== –≠—Ç–∞–ø 2. –ü–æ—Ç–µ—Ä—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞
–≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É –°–£–ë–î –Ω–∞ –†–ï–ó–ï–†–í–ù–û–ú —É–∑–ª–µ,
–ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –°–£–ë–î –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

== –≠—Ç–∞–ø 3. –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ë–î
–≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Å–±–æ—è –¥–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã) –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –°–£–ë–î
–Ω–∞ –û–°–ù–û–í–ù–û–ú —É–∑–ª–µ.

–•–æ–¥ —Ä–∞–±–æ—Ç—ã:

- –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–±–æ–π:
    - —É–¥–∞–ª–∏—Ç—å —Å –¥–∏—Å–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é WAL —Å–æ –≤—Å–µ–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –°–£–ë–î, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –°–£–ë–î, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
- –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏, —É—á–∏—Ç—ã–≤–∞—è —Å–ª–µ–¥—É—é—â–µ–µ —É—Å–ª–æ–≤–∏–µ:
    - –∏—Å—Ö–æ–¥–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ - —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏
    —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –°–£–ë–î, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

== –≠—Ç–∞–ø 4. –õ–æ–≥–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
–≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω—É—é –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö (–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–π –∏–ª–∏ –æ—à–∏–±–æ—á–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏) –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
 –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –û–°–ù–û–í–ù–û–ú —É–∑–ª–µ —Å–ª–µ–¥—É—é—â–∏–º —Å–ø–æ—Å–æ–±–æ–º:

- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —É–∑–ª–µ —Å –ø–æ–º–æ—â—å—é pg_dump –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ.

–•–æ–¥ —Ä–∞–±–æ—Ç—ã:
- –í –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É –±–∞–∑—ã –¥–æ–±–∞–≤–∏—Ç—å 2-3 –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –∏ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É:
    - –≤ –ª—é–±–æ–π —Ç–∞–±–ª–∏—Ü–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏ –ø–æ–¥–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–µ–π –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–µ (INSERT, UPDATE)
- –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
- –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.
- –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.


= –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

== –≠—Ç–∞–ø 1. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ –∑–∞–¥–∞–¥–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ WAL —Ñ–∞–π–ª–æ–≤ –∏ –∏—Ö –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —É–∑–µ–ª:
```conf
wal_level = replica
archive_mode = on
archive_command = 'scp %p postgres1@pg114:/var/db/postgres1/wal_archive/%f'
```

–ü–æ–¥–∫–ª—é—á–∏–º—Å—è –∫–∞–∫ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```sh
psql -h localhost -p 9455 -U postgres0 -d postgres
```
–°–æ–∑–¥–∞–¥–∏–º —Ä–æ–ª—å replicator —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é:
```sql
CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD
'pass123';
```
–ù–∞–ø–∏—à–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ø–∏–∏:
```sh
#!/bin/bash
# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ
LOCAL_BACKUP_DIR="/var/db/postgres0/backups/$(date +%Y-%m-%d_%H-%M-%S)"
# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —É–∑–ª–µ
REMOTE_BACKUP_DIR="/var/db/postgres1/backups/$(date +%Y-%m-%d_%H-%M-%S)"
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ
mkdir -p $LOCAL_BACKUP_DIR
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —É–∑–ª–µ
ssh pg1 "mkdir -p $REMOTE_BACKUP_DIR"

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ
pg_basebackup -D $LOCAL_BACKUP_DIR -Ft -z -Xs -P -U replicator -h pg109 -p 9455
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
if [ $? -eq 0 ]; then
  echo "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ: $LOCAL_BACKUP_DIR"
  # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —É–∑–µ–ª
  scp -r $LOCAL_BACKUP_DIR/* pg1:$REMOTE_BACKUP_DIR/
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  if [ $? -eq 0 ]; then
    echo "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —É–∑–µ–ª: $REMOTE_BACKUP_DIR"
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ (—Å—Ç–∞—Ä—à–µ 1 –Ω–µ–¥–µ–ª–∏)
    find /var/db/postgres0/backups -type d -mtime +7 -exec rm -rf {} \;
    echo "–°—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —É–¥–∞–ª–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ"
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —É–∑–ª–µ (—Å—Ç–∞—Ä—à–µ 4 –Ω–µ–¥–µ–ª—å)
    ssh pg1 "find /var/db/postgres1/backups -type d -mtime +28 -exec rm -rf {} \;"
    echo "–°—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —É–¥–∞–ª–µ–Ω—ã –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —É–∑–ª–µ"
  else
    echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —É–∑–µ–ª"
    exit 1
  fi
else
  echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ"
  exit 1
fi
```

–î–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```sh
chmod +x /var/db/postgres0/script1.sh
```

–ù–∞—Å—Ç—Ä–æ–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ —Å –ø–æ–º–æ—â—å—é –∫—Ä–æ–Ω—ã —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
```sh
crontab -e
0 3 * * 1 /var/db/postgres0/script1.sh
```
#image("img/img.png")

=== –ü–æ–¥—Å—á–µ—Ç –æ–±—ä–µ–º–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–£—Å–ª–æ–≤–∏—è:
- –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î –∑–∞ —Å—É—Ç–∫–∏: 350–ú–ë.
- –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å—É—Ç–∫–∏: 800–ú–ë.

==== –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ –±–µ–∫–∞–ø–æ–≤

–í —Å—É—Ç–∫–∏ –±—É–¥–µ—Ç $350$ –ú–ë–∞–π—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–µ–π

$ S_"back" = (2*0 + 350 * (30-1))/2 * 30 = 152250 "–ú–ë" = 149 "–ì–ë"  $

–†–∞–∑–º–µ—Ä –±–µ–∫–∞–ø–æ–≤ –∑–∞ –º–µ—Å—è—Ü  - 149 –ì–±

==== –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ wal –∞—Ä—Ö–∏–≤–æ–≤

wal_segsize = 16 –ú–±

–û–±—ä–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π - 800 –ú–± -> 50 c–µ–≥–º–µ–Ω—Ç–æ–≤ = —Ä–∞–∑–º–µ—Ä wal_archive –∑–∞ —Å—É—Ç–∫–∏ - 800–ú–±

$ S_"wal" = ((30-1) * 800) / 2 * 30 = 348000 "–ú–±" = 340 "–ì–±" $

==== –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä

$ S = S_"backup" + S_"wal" = 340 + 149 = 489 "–ì–±" $

–ò—Ç–æ–≥–æ —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ–º 489 –ì–± –±–µ–∫–∞–ø–æ–≤





–£—Å–ª–æ–≤–∏—è:
- –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î –∑–∞ —Å—É—Ç–∫–∏: 350–ú–ë
- –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å—É—Ç–∫–∏: 800–ú–ë
- –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
- –ö–∞–∂–¥–∞—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π + –∞—Ä—Ö–∏–≤–∞—Ü–∏—è WAL
650 –ú–ë
= 325 –ú–ë
2
–†–∞—Å—á–µ—Ç—ã:
1. –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å—É—Ç–∫–∏:
‚Ä¢ –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: 300 –ú–ë
‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: 350 –ú–ë
‚Ä¢ –ò—Ç–æ–≥–æ –∑–∞ —Å—É—Ç–∫–∏: 300 –ú–ë + 350 –ú–ë = 650 –ú–ë
2. –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –∑–∞ –æ–¥–Ω—É —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:
–ü–æ—Å–∫–æ–ª—å–∫—É —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è 2 —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏, –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö,
–¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö –∑–∞ –æ–¥–Ω—É –∫–æ–ø–∏—é, –±—É–¥–µ—Ç:
–û–±—ä–µ–º –æ–¥–Ω–æ–π –∫–æ–ø–∏–∏ =
3. –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –∑–∞ –º–µ—Å—è—Ü:
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ: 30
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –≤ —Å—É—Ç–∫–∏: 2
‚Ä¢ –ò—Ç–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü: 325 –ú–ë/–∫–æ–ø–∏—è * 2 –∫–æ–ø–∏–∏/–¥–µ–Ω—å * 30 –¥–Ω–µ–π = 19 500 –ú–ë
= 19,5 –ì–ë
4. –û–±—ä–µ–º –≤—Å–µ—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∑–∞ –º–µ—Å—è—Ü:
–ï—Å–ª–∏ –∫–∞–∂–¥–∞—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π, —Ç–æ:
‚Ä¢ –û–±—ä–µ–º –æ–¥–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 325 –ú–ë –∫–∞–∂–¥—ã–µ 12
—á–∞—Å–æ–≤
‚Ä¢ –ü—Ä–∏–º–µ—Ä –¥–ª—è –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –¥–Ω–µ–π:
o 1-—è –∫–æ–ø–∏—è (–¥–µ–Ω—å 1, 0:00‚Äì12:00): 325 –ú–ë
o 2-—è –∫–æ–ø–∏—è (–¥–µ–Ω—å 1, 12:00‚Äì24:00): 325 + 325 = 650 –ú–ë
o 3-—è –∫–æ–ø–∏—è (–¥–µ–Ω—å 2, 0:00‚Äì12:00): 650 + 325 = 975 –ú–ë
o 4-—è –∫–æ–ø–∏—è (–¥–µ–Ω—å 2, 12:00‚Äì24:00): 975 + 325 = 1,300 –ú–ë
–≠—Ç–æ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è, –≥–¥–µ:
‚Ä¢ –ü–µ—Ä–≤—ã–π —á–ª–µ–Ω (a1) = 325 –ú–ë
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–ª–µ–Ω (a60) = 325√ó60 = 19500 –ú–ë
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–ª–µ–Ω–æ–≤ (n) = 60 (2 –∫–æ–ø–∏–∏/–¥–µ–Ω—å * 30 –¥–Ω–µ–π)
–°—É–º–º–∞ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏:
ùëõ √ó (ùëé1 + ùëéùëõ)
ùëÜùëõ
=
60 √ó (325 + 19500)
ùëÜ60 =
2
= 594750 –ú–ë = 594,75–ì–ë
2
–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–æ–ª–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π 2 —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏ –æ–±—ä–µ–º –∑–∞ –º–µ—Å—è—Ü
—Å–æ—Å—Ç–∞–≤–∏—Ç 604,5 –ì–ë. –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∏–ª–∏ —Å–∂–∞—Ç–∏–µ. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
—Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏. –≠—Ç–æ
–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç –æ–±—ä–µ–º —Ö—Ä–∞–Ω–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
—Å–∂–∞—Ç–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, gzip –∏–ª–∏ zstd), —Ç–æ –æ–±—ä–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —É–º–µ–Ω—å—à–∏—Ç—Å—è.
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∂–∞—Ç–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –æ–±—ã—á–Ω–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 2‚Äì4 —Ä–∞–∑–∞.
–ò–∑ –ø–ª—é—Å–æ–≤: —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å—Ç–∞—Ä—à–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å—Ä–æ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
—É–¥–∞–ª—è—é—Ç—Å—è.

== –≠—Ç–∞–ø 2. –ü–æ—Ç–µ—Ä—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞
–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ—Å—Å–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ —Ç–∞–±–ª–∏—á–Ω–æ–≥–æ
–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —É–∑–ª–µ –∏–∑ –Ω–∞—à–µ–≥–æ –±—ç–∫–∞–ø–∞:
```sh
mkdir -p /var/db/postgres1/u08/djs10
cp -r ~/backups/2025-04-06_20-13-07/* /var/db/postgres1/u08/djs10
chmod 750 /var/db/postgres1/u08/djs10
# –†–∞—Å–ø–∞–∫—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:
cd ~/u08/djs10
tar -xzf base.tar.gz
tar -xzf pg_wal.tar.gz
tar -xzf 16387.tar.gz
tar -xzf 16388.tar.gz
# –£–∫–∞–∂–µ–º –≤ postgresql.conf –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ wal-—Ñ–∞–π–ª–æ–≤:
echo "restore_command = 'cp /var/db/postgres1/wal_archive/%f %p'">> /var/db/postgres1/u08/djs10/postgresql.conf
# –°–æ–∑–¥–∞–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ —Ñ–∞–π–ª, —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:
touch ~/u08/djs10/recovery.signal
# –ó–∞–ø—É—Å—Ç–∏–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä:
pg_ctl -D ~/u08/djs10 start
# –ü—Ä–æ–≤–µ—Ä–∏–º —Å—Ç–∞—Ç—É—Å:
pg_ctl -D ~/u08/djs10 status
```
#image("img/img_1.png")

–ü—Ä–æ–≤–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—ã –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –±–¥:
```sh
psql -h pg109 -p 9455 -U new_user -d leftbrownmom
\d
```
#image("img/img_2.png")

== –≠—Ç–∞–ø 3. –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ë–î
–£–¥–∞–ª–∏–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å WAL —Ñ–∞–π–ª–∞–º–∏ –∏ –∑–∞–ø—É—Å—Ç–∏–º —Å–µ—Ä–≤–µ—Ä
#image("img/img_3.png")

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
```sh
mkdir -p ~/u08_new/djs10
chmod 750 ~/u08_new/djs10
cd ~/u08_new/djs10
# –†–∞—Å–ø–∞–∫—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:
tar -xzf ~/backups/2025-04-06_19-29-44/base.tar.gz -C ~/u08_new/djs10
mkdir -p ~/u08_new/djs10/pg_wal
tar -xzf ~/backups/2025-04-06_19-29-44/pg_wal.tar.gz -C ~/u08_new/djs10/pg_wal
mkdir -p ~/cje38_new
tar -xzf ~/backups/2025-04-06_19-29-44/16387.tar.gz -C ~/cje38_new/
mkdir -p ~/qdx64_new
tar -xzf ~/backups/2025-04-06_19-29-44/16388.tar.gz -C ~/qdx64_new/
# –°–æ–∑–¥–∞–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ —Ñ–∞–π–ª, —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:
touch ~/u08_new/djs10/recovery.signal
```
–£–∫–∞–∂–µ–º –≤ postgresql.conf –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ wal —Ñ–∞–π–ª–æ–≤:
```conf
echo "restore_command = 'cp /home/postgres0/u08_new/djs10/pg_wal/%f %p'" > postgresql.conf
```

–ó–∞–ø—É—Å—Ç–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä:
pg_ctl -D ~/u08_new/djs10 start
#image("img/img_5.png")
–ü–æ–¥–∫–ª—é—á–∏–º—Å—è –∫ –±–¥ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º —Ç–∞–±–ª–∏—Ü—ã:
```sh
psql -h pg109 -p 9455 -U new_user -d leftbrownmom
\d
```
#image("img/img_5.png")
== –≠—Ç–∞–ø 4. –õ–æ–≥–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

== –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ

==== –°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏

```sql
CREATE TABLE IF NOT EXISTS students (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS lessons (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL,
  title TEXT NOT NULL,
  FOREIGN KEY (student_id) REFERENCES students(id)
);
```

==== –î–æ–±–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏

```sql
INSERT INTO students (name) VALUES
  ('–ê–∑–∞—Ç'),
  ('–£–ª—å—è–Ω–∞');
INSERT INTO lessons (student_id, title) VALUES
  ((SELECT id FROM students WHERE name='–ê–∑–∞—Ç'), '–†–°–•–î –∞–∑–∞—Ç'),
  ((SELECT id FROM students WHERE name='–£–ª—å—è–Ω–∞'), '–†–°–•–î —É–ª—å—è–Ω–∞');
```

–ü–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å:

```sql
SELECT * from lessons join students on (student_id = students.id);
```

#image("img/select_result_4.png")

==== –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

#image("img/error_time.png")

==== –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞–º–ø–∞

–°–¥–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç create_dump.sh

```sh
#!/bin/bash

dumps_dir="${HOME}/dumps/"
dump_name="db-$(date +"%m-%d-%Y-%H-%M-%S").dump"

pg_dump -h pg109 -p 9455 -d leftbrownmom -U new_user -Fc > $dumps_dir$dump_name
```

–î–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª–Ω–∏–º

```sh
chmod +x ${HOME}/create_dump.sh
mkdir dumps
bash ./create_dump.sh
```

==== –ò–º–º–∏—Ç–∞—Ü–∏—è –ø–æ—Ä—á–∏ –¥–∞–Ω–Ω—ã—Ö

```sql
ALTER TABLE lessons DROP CONSTRAINT lessons_student_id_fkey;

UPDATE lessons
  SET student_id = 10000
WHERE id IN (
  SELECT id FROM lessons LIMIT 1
);

DELETE FROM students where name = '–£–ª—å—è–Ω–∞';
```

–ü–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å:

```sql
SELECT * from lessons join students on (student_id = students.id);
```

#image("img/select_result_after_drop.png")

==== –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–¥–∏–º —Å–∫—Ä–∏–ø—Ç
```sh
#!/bin/bash

dumps_dir="dumps/"

dump_name=$1

rsync --rsync-path=/usr/local/bin/rsync --archive postgres0@pg109:~/$dumps_dir$dump_name ~/
pg_restore -h pg114 -p 9455 -d leftbrownmom -U new_user -c $dump_name -v
rm -rf $dump_name
```

–í—ã–¥–∞–¥–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª–Ω–∏–º
```sh
chmod +x ./restore_dump.sh

bash ./restore_dump.sh db-04-21-2025-02-03-47.dump
```

#image("img/restore_result.png")

–ü–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –º—ã —É–≤–∏–¥–∏–º –≤ —Ç–∞–±–ª–∏—Ü–µ

```sql
SELECT * from lessons join students on (student_id = students.id);
```

#image("img/restore_result_tables.png")

–ò—Ç–æ–≥–æ: –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

= –í—ã–≤–æ–¥

–í —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–∞–ø–æ–≤ postgresql, –∏ –∏—Å–ø—ã—Ç–∞–ª–∏ –ø—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö:
–ø–æ–ª–Ω–æ–π –ø–æ—Ç–µ—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –ë–î –∏–ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
